<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Barcode PDF Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
  <div class="card shadow">
    <div class="card-body">
      <h2 class="card-title mb-4 text-center">Barcode PDF Generator</h2>

      <form id="configForm" class="row g-3 mb-3">
        <div class="col-md-3">
          <label for="companyName" class="form-label">Company Name</label>
          <input type="text" value="SHREERAM DRESSES" id="companyName" class="form-control" required>
        </div>
        <div class="col-md-3">
          <label for="rowsPerPage" class="form-label">Rows per page</label>
          <input type="number" id="rowsPerPage" class="form-control" value="8" required>
        </div>
        <div class="col-md-3">
          <label for="columnsPerPage" class="form-label">Columns per page</label>
          <input type="number" id="columnsPerPage" class="form-control" value="3" required>
        </div>
        <div class="col-md-3">
          <label for="startPosition" class="form-label">Start Position</label>
          <input type="number" id="startPosition" class="form-control" value="1" min="1" required>
        </div>
      </form>

      <h5 class="mt-4">Items Table</h5>
      <div class="table-responsive">
        <table id="dataTable" class="table table-bordered table-striped align-middle">
          <thead class="table-light">
            <tr>
              <th>Item Name</th>
              <th>Price</th>
              <th>Barcode Number</th>
              <th>Quantity</th>
              <th>Unit</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td contenteditable="true">Sample Item</td>
              <td contenteditable="true">100</td>
              <td>
                <div class="input-group input-group-sm">
                  <input type="text" class="form-control barcode-input" value="123456">
                  <button class="btn btn-outline-secondary" type="button" onclick="generateRandom6Digit(this)">üîÑ</button>
                </div>
              </td>
              <td contenteditable="true">2</td>
              <td>
                <select class="form-select form-select-sm">
                  <option value="Box">Box</option>
                  <option value="Pcs">Pcs</option>
                  <option value="Numbers">Numbers</option>
                  <option value="Pairs">Pairs</option>
                </select>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button type="button" onclick="addRow()" class="btn btn-outline-primary">‚ûï Add Row</button>
        <button type="button" onclick="generatePDF()" class="btn btn-success">üßæ Generate PDF</button>
      </div>
    </div>
  </div>
</div>

<script>
function addRow() {
  const tableBody = document.querySelector('#dataTable tbody');
  const newRow = document.createElement('tr');
  newRow.innerHTML = `
    <td contenteditable="true">New Item</td>
    <td contenteditable="true">0</td>
    <td>
      <div class="input-group input-group-sm">
        <input type="text" class="form-control barcode-input" value="000000">
        <button class="btn btn-outline-secondary" type="button" onclick="generateRandom6Digit(this)">üîÑ</button>
      </div>
    </td>
    <td contenteditable="true">1</td>
    <td>
      <select class="form-select form-select-sm">
        <option value="Box">Box</option>
        <option value="Pcs">Pcs</option>
        <option value="Numbers">Numbers</option>
        <option value="Pairs">Pairs</option>
      </select>
    </td>
  `;
  tableBody.appendChild(newRow);
}

function generateRandom6Digit(button) {
  const randomNumber = Math.floor(100000 + Math.random() * 900000).toString();
  const input = button.closest('.input-group').querySelector('.barcode-input');
  input.value = randomNumber;
}

async function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const company = document.getElementById("companyName").value.trim();
  const rowsPerPage = parseInt(document.getElementById("rowsPerPage").value);
  const colsPerPage = parseInt(document.getElementById("columnsPerPage").value);
  const startPosition = parseInt(document.getElementById("startPosition").value);
  const xOffset = 2;

  const pageWidth = 210;
  const pageHeight = 297;
  const margin = 10;

  const labelWidth = (pageWidth - 2 * margin) / colsPerPage;
  const labelHeight = (pageHeight - 2 * margin) / rowsPerPage;

  let x = margin;
  let y = margin;
  let col = 0;
  let labelCount = 0;

  const rows = document.querySelectorAll("#dataTable tbody tr");

  for (let i = 1; i < startPosition; i++) {
    labelCount++;
    col++;
    if (col >= colsPerPage) {
      col = 0;
      x = margin;
      y += labelHeight;
    } else {
      x += labelWidth;
    }
  }

  for (const tableRow of rows) {
    const cells = tableRow.querySelectorAll("td");
    if (cells.length < 4) continue;

    const itemName = cells[0].innerText.trim();
    const price = cells[1].innerText.trim();
    const barcode = cells[2].querySelector("input")?.value.trim(); // Updated
    const quantity = parseInt(cells[3].innerText.trim());

    for (let i = 0; i < quantity; i++) {
      if (y + labelHeight > pageHeight - margin) {
        doc.addPage();
        x = margin;
        y = margin;
        col = 0;
      }

      const canvas = document.createElement("canvas");
      try {
        JsBarcode(canvas, barcode, {
          format: "CODE39",
          displayValue: false,
          width: 1.5,
          height: 8,
          margin: 0
        });
        const imgData = canvas.toDataURL("image/png");

        doc.setFontSize(10);
        const companyWidth = doc.getTextWidth(company);
        doc.text(company, x + xOffset + (labelWidth - companyWidth) / 2, y + 5);

        const barcodeImgWidth = labelWidth * 0.8;
        const barcodeImgHeight = 10;
        const barcodeX = x + xOffset + (labelWidth - barcodeImgWidth) / 2;
        const barcodeY = y + 7;
        doc.addImage(imgData, "PNG", barcodeX, barcodeY, barcodeImgWidth, barcodeImgHeight);

        doc.setFontSize(9);
        doc.setFont("courier", "bold");
        const barcodeTextWidth = doc.getTextWidth(barcode);
        doc.text(barcode, x + xOffset + (labelWidth - barcodeTextWidth) / 2, barcodeY + barcodeImgHeight + 4);

        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        const nameWidth = doc.getTextWidth(itemName);
        doc.text(itemName, x + xOffset + (labelWidth - nameWidth) / 2, barcodeY + barcodeImgHeight + 8);

        const priceText = `Rs. ${price}`;
        const priceWidth = doc.getTextWidth(priceText);
        doc.text(priceText, x + xOffset + (labelWidth - priceWidth) / 2, barcodeY + barcodeImgHeight + 12);

        labelCount++;
        col++;
        if (col >= colsPerPage) {
          col = 0;
          x = margin;
          y += labelHeight;
        } else {
          x += labelWidth;
        }
      } catch (e) {
        console.warn(`‚ùå Skipping invalid barcode: "${barcode}"`, e);
        continue;
      }
    }
  }

  window.open(doc.output('bloburl'), '_blank').print();
}
</script>

</body>
</html>
